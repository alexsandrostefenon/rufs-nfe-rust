<html lang="pt-BR" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <link rel="manifest" href="manifest.json">

	<!-- 
	 <link href="bootstrap-5.3.2-dist/css/bootstrap.css" rel="stylesheet">
	 <script src="bootstrap-5.3.2-dist/js/bootstrap.js"></script>
	 -->
	 <link href="webapp/bootstrap-5.3.0-alpha3.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
	 <script src="webapp/bootstrap-5.3.0-alpha3.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
	 <script src="webapp/lib/Chart-2.7.3.min.js" type="text/javascript"></script>
  </head>

  <body>
	<div id="menu"></div>

	<div id="http-log" class="alert alert-info" role="alert" hidden></div>
	<div id="http-working" class="alert alert-info" role="alert" hidden></div>
	<div id="http-error"   class="alert alert-danger" role="alert" hidden></div>

	<div class="card">
		<form id="login" name='login'">
			<div class="card-header">Controle de Acesso</div>
		
			<div class="card-body">
				<div class="form-group">
					<label for="customer_id">CNPJ</label>
					<input type="text" name="customer_id" id="login-customer_id" class="form-control" autocomplete="customer" disabled required pattern="(\d{3}\d{3}\d{3}\d{2}$)|\d{3}\.\d{3}\.\d{3}-\d{2}$)|(^\d{2}\d{3}\d{3}\d{4}\d{2}|(^\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2})"/>
				</div>

				<div class="form-group">
					<label for="user">Usu√°rio</label>
					<input type="text" name="user" id="login-user" style="text-transform: lowercase;" class="form-control" autocomplete="user" required/>
				</div>
				
				<div class="form-group">
					<label for="password">Senha</label>
					<input type="password" name="password" id="login-password" class="form-control" autocomplete="password" required/>
				</div>
				
				<button id="login-send" name='send' class="btn btn-default">Ok</button>
			</div>
		</form>
	</div>

    <div id="main"></div>

	<script type="module">
		class DataViewManagerWs {

			constructor(server_url) {
				this.server_url = server_url;
			}

			login(obj_in) {
				let url = `${this.server_url}/wasm_ws/login`;
				let options = {method: "POST", body: JSON.stringify(obj_in), headers: {}};
				options.headers["Content-Type"] = "application/json";
				return fetch(url, options).
				then(response => {
					if (response.status != 200) {
						return response.text().
						then(text => {
							throw text
						});
					}

					return response.json();
				}).
				then(login_response => {
					this.token = login_response.jwt_header;
					return login_response;
				});
			}

			process(obj_in) {
				let options = {method: "POST", body: JSON.stringify(obj_in), headers: {}};
				options.headers["Content-Type"] = "application/json";

				if (this.token != undefined) {
					options.headers["Authorization"] = "Bearer " + this.token;
				}

				let url = `${this.server_url}/wasm_ws/process`;
				return fetch(url, options).
				then(response => {
					if (response.status != 200) {
						return response.text().
						then(text => {
							throw text
						});
					}

					return response.json();
				});
			}

		}

		async function login(event) {
			document.querySelector('#http-error').hidden = true;
			document.querySelector('#http-working').innerHTML = "Aguardando resposta do servidor...";
			document.querySelector('#http-working').hidden = false;
			let element = event.target; let rowIndex = 0;
			const form = element.form;

			if (form.reportValidity()) {
				//event.stopPropagation();
				event.preventDefault();
				let customer_user;
				const customer_id = form.customer_id.value.replaceAll(/\D/g, "");

				if (customer_id.length > 0) {
					customer_user = `${customer_id}.${form.user.value}`;
				} else {
					customer_user = form.user.value;
				}

				let dataViewManager;
				let promise;

				{
					let server_url = window.location.origin + window.location.pathname;

					if (server_url.endsWith("/")) {
						server_url = server_url.substring(0, server_url.length - 1);
					}

					const urlParams = new URLSearchParams(document.location.search);
					const mode = urlParams.get("mode");
					const loginBody = {user: customer_user, password: form.password.value};

					if (mode == "ws") {
						dataViewManager = new DataViewManagerWs(server_url);
						promise = dataViewManager.login(loginBody);
					} else {
						const response = await fetch(server_url+"/rest/login", {"body": JSON.stringify(loginBody), "method": "POST"});

						if (!response.ok) {
							throw new Error(`HTTP error! Status: ${response.status}`);
						}

						const login_response = await response.text();
						const wasm_js = await import("../pkg/rufs_nfe_rust.js");
						await wasm_js.default();
						dataViewManager = new wasm_js.DataViewManager(server_url);
						promise = dataViewManager.login_from_response(login_response);
					}
				}

				promise.
				then(async (login_response) => {
					const module = await import("./webapp/es6/app.js");
					module.processLoginResponse(login_response, dataViewManager);
					form.hidden = true;
				}).catch(err => {
					console.error(err);
					document.querySelector('#http-error').innerHTML = err;
					document.querySelector('#http-error').hidden = false;
				}).finally(() => {
					document.querySelector('#http-working').hidden = true;
				});
			}
		}

		async function run() {
			const urlParams = new URLSearchParams(document.location.search);
			const trace = urlParams.get("trace");

			if (trace == "true") {
				const http_log = document.getElementById('http-log');
				http_log.hidden = false;
			}

			const element = document.getElementById("login-customer_id");

			if (urlParams.get("customer_id") != null) {
				element.value = urlParams.get("customer_id");
			}

			element.disabled = false;
			document.getElementById('login-send').addEventListener('click', login);
		}

		await run();
  </script>
  </body>
</html>
